var app=angular.module("app",["ngMaterial"]);app.service("transactionsService",["$http","$q","$rootScope",function(t,n,e){this.service=function(e,a,r){var i=n.defer();return t({method:e,url:"http://localhost:3000/"+a,data:r}).then(function(t){i.resolve(t.data)},function(t){i.reject(t.statusText)}),i.promise};var a=0;this.setUpdateStatus=function(t){a=t,e.$broadcast("transactions:updated",!0)},this.getUpdateStatus=function(){return a};var r=0;this.setFilterStatus=function(t){r=t,e.$broadcast("transactions:filter",!0)},this.getFilterStatus=function(){return r}}]),app.filter("filterSearchTransaction",["$filter","$q",function(t){return function(n,e){var a=[];return angular.forEach(n,function(t){t.date=new Date(t.date);var n=null===e.date.start||t.date>=e.date.start,r=t.date<=e.date.end,i=""===e.accountId||t.accountId===e.accountId,o=""===e.categoryId||t.categoryId===e.categoryId,c=""===e.statusId||t.statusId===e.statusId;n&&r&&i&&o&&c&&a.push(t)}),""!==e.description&&(a=t("filter")(a,e.description)),a}}]),app.filter("filterCreditTransactions",["$filter","$q",function(t){return function(t,n){var e=[];return angular.forEach(t,function(t){var n=1===t.accountId,a=1===t.statusId||3===t.statusId;n&&a&&e.push(t)}),e}}]),app.filter("filterDraftTransactions",["$filter","$q",function(t){return function(t,n){var e=[];return angular.forEach(t,function(t){0===t.statusId&&e.push(t)}),e}}]),app.directive("transactionsAdd",["transactionsService",function(t){return{restrict:"E",replace:!0,templateUrl:"app/components/add/view.html",controller:function(n,e){function a(){var a=e.defer(),r=[];return t.service("GET","categories").then(function(t){r.push(n.categories=t)}),t.service("GET","status").then(function(t){r.push(n.status=t)}),t.service("GET","accounts").then(function(t){r.push(n.accounts=t)}),e.all(r).then(function(){a.resolve()}),a.promise}var r=new Date;n.transaction={date:r,description:"",accountId:0,categoryId:0,statusId:0,parentId:0,amount:null},a(),this.isValid=function(){return""!==n.transaction.description&&0!==n.transaction.amount},n.isUpdating=!1,this.updateData=function(){t.service("POST","transactions/",n.transaction).then(function(){n.isUpdating=!0,t.setUpdateStatus(1)})},this.updateDone=function(){n.isUpdating=!1,t.setUpdateStatus(0);var e=new Date;n.transaction={date:e,description:"",accountId:0,categoryId:0,statusId:0,parentId:0,amount:null},n.$apply()}},link:function(n,e,a,r){var i=($(e).find(".transaction-form"),$(e).find(".transaction-sync")),o=$(e).find(".transaction-submit");i.hide(),n.add=function(t){t.preventDefault(),r.isValid()&&o.fadeOut().promise().done(function(){i.fadeIn().promise().done(function(){r.updateData()})})},n.$on("transactions:updated",function(e,a){2===t.getUpdateStatus()&&n.isUpdating&&i.fadeOut().promise().then(function(){o.fadeIn().promise().then(function(){r.updateDone()})})})}}}]),app.directive("dashboard",["transactionsService",function(t){return{restrict:"E",replace:!0,templateUrl:"app/components/dashboard/view.html",controller:function(t){},link:function(t,n,e,a){}}}]),app.directive("transactionsSummary",function(){return{restrict:"E",replace:!0,templateUrl:"app/components/summary/view.html",controller:function(t,n,e,a){t.balance={overall:"",debit:"",credit:""},this.init=function(){var r=a.defer();return n.service("GET","transactions?accountId=0&statusId=1&statusId=2").then(function(a){var i={overall:0,debit:0,credit:0};angular.forEach(a,function(t){i.debit+=t.amount}),n.service("GET","transactions?accountId=1&statusId=1&statusId=3").then(function(n){angular.forEach(n,function(t){i.credit+=t.amount}),i.overall=i.debit-i.credit,i.overall=e("currency")(i.overall,"$"),i.debit=e("currency")(i.debit,"$"),i.credit=e("currency")(i.credit,"$"),t.balance=i,r.resolve()})}),r.promise}},link:function(t,n,e,a){var r=$(n).find("p");r.hide(),a.init().then(function(){r.fadeIn()})}}}),app.directive("transactionsTransactions",function(){return{restrict:"E",replace:!0,templateUrl:"app/components/transactions/view.html",controller:function(t){},link:function(t,n,e,a){}}}),app.directive("dashboardCharts",["transactionsService",function(t){return{restrict:"E",replace:!0,templateUrl:"app/components/dashboard/charts/view.html",controller:function(t){},link:function(t,n,e,a){}}}]),app.directive("dashboardBalances",["transactionsService",function(t){return{restrict:"E",replace:!0,templateUrl:"app/components/dashboard/balances/view.html",controller:function(n,e){function a(t){for(var a=e.defer(),r=0,i=1,o=t.length-1;o>=0;o--){var c=t[o];i=n.categories[c.categoryId]&&"Expense"===n.categories[c.categoryId].parentId?-1:1,c.balance=r+i*c.amount,r=c.balance}return a.resolve(r),a.promise}n.balance={overall:0,debit:0,credit:0},n.isBalancing=!0,t.service("GET","transactions?_sort=date&_order=DESC&accountId=0").then(function(e){a(e).then(function(e){n.balance.debit=e,t.service("GET","transactions?_sort=date&_order=DESC&accountId=1").then(function(t){a(t).then(function(t){n.balance.credit=t,n.balance.overall=n.balance.debit+n.balance.credit,n.isBalancing=!1})})})})},link:function(t,n,e,a){var r=$(n).find(".content p");r.hide(),t.$watch("isBalancing",function(){t.isBalancing||r.fadeIn()})}}}]),app.directive("dashboardTransactions",["transactionsService",function(t){return{restrict:"E",replace:!0,templateUrl:"app/components/dashboard/transactions/view.html",controller:function(t){},link:function(t,n,e,a){}}}]),app.directive("transactionsEdit",function(){return{restrict:"A",scope:!0,controller:function(t,n,e){this.isValid=function(t){return t==t},this.updateData=function(t){e.service("PUT","transactions/"+t.id,t).then(function(){e.setUpdateStatus(1)})}},link:function(t,n,e,a){var r=$(n).find(".transaction-data"),i=$(n).find(".transaction-edit-trigger"),o=$(n).find(".transaction-edit"),c=$(n).find(".transaction-sync"),s=!1,u=!1;i.hide(),o.hide(),c.hide(),$(n).bind("mouseover",function(){$(n).removeClass("pointer"),u||($(n).addClass("pointer"),i.fadeIn().promise().done(function(){s=!0}))}),$(n).bind("mouseleave",function(){$(n).removeClass("pointer"),u||($(n).addClass("pointer"),i.fadeOut().promise().done(function(){s=!1}))}),$(n).bind("click",function(){s&&(u=!0,s=!1,i.hide().promise().done(function(){r.fadeOut().promise().done(function(){o.fadeIn()})}))}),t.save=function(t,n){n&&n.preventDefault(),a.isValid(t)&&o.fadeOut().promise().done(function(){c.fadeIn().promise().done(function(){a.updateData(t)})})}}}}),app.directive("transactionsSearch",["transactionsService",function(t){return{restrict:"E",replace:!0,templateUrl:"app/components/transactions/search/view.html",controller:function(n,e,a){function r(){var e=a.defer(),r=[];return t.service("GET","categories").then(function(t){r.push(n.categories=t)}),t.service("GET","status").then(function(t){r.push(n.status=t)}),t.service("GET","accounts").then(function(t){r.push(n.accounts=t)}),a.all(r).then(function(){e.resolve()}),e.promise}n.categories=[],n.status=[],n.accounts=[],n.headers=["Date","Description","Account","Category","Amount","Balance","Status"],n.transactions=[];var i=new Date;n.filterProperties={date:{start:null,end:i},description:"",accountId:"",categoryId:"",statusId:""},r(),this.searchDone=function(){var e=new Date;n.filterProperties={date:{start:null,end:e},description:"",accountId:"",categoryId:"",statusId:""},n.$apply(),t.setFilterStatus(0)}},link:function(n,e,a,r){var i=$(e).find(".transaction-sync"),o=$(e).find(".transaction-search-element"),c=!1;i.hide(),n.search=function(n){n&&n.preventDefault(),o.fadeOut().promise().done(function(){i.fadeIn().promise().done(function(){c=!0,t.setFilterStatus(1)})})},n.$on("transactions:filter",function(n,e){2===t.getFilterStatus()&&c&&i.fadeOut().promise().done(function(){o.fadeIn().promise().done(function(){c=!1,r.searchDone()})})})}}}]),app.directive("transactionsDelete",["transactionsService",function(t){return{restrict:"A",scope:!0,controller:function(t,n,e){this.deleteData=function(t,a){var r=e.defer(),i=a.description,o=n.confirm().title("Would you like to delete this transaction?").textContent(i).ariaLabel(a.description).targetEvent(t).ok("Yes").cancel("No");return n.show(o).then(function(){r.resolve("delete")},function(){r.resolve("cancel")}),r.promise}},link:function(n,e,a,r){var i=$(e).find(".transaction-delete-trigger"),o=$(e).find(".transaction-sync"),c=!1;i.hide(),o.hide(),$(e).bind("mouseover",function(){c||i.fadeIn()}),$(e).bind("mouseleave",function(){c||i.fadeOut()}),n["delete"]=function(n,e){c=!0,i.fadeIn().promise().then(function(){r.deleteData(n,e).then(function(n){"delete"===n?i.fadeOut().promise().then(function(){o.fadeIn().promise().then(function(){t.service("DELETE","transactions/"+e.id).then(function(){t.setUpdateStatus(1),c=!1})})}):i.fadeOut().promise().then(function(){c=!1})})})}}}}]),app.directive("transactionsTable",function(){return{restrict:"E",replace:!0,scope:{type:"@",filter:"="},templateUrl:"app/components/transactions/table/view.html",controller:function(t,n,e,a){function r(n){if("undefined"==typeof t.type)t.transactions=n;else{var e="";e="credit"===t.type?"filterCreditTransactions":"filterDraftTransactions",t.transactions=a(e)(n)}}function i(){var a=e.defer(),r=[];return n.service("GET","categories").then(function(n){t.categories=n,r.push()}),n.service("GET","status").then(function(n){r.push(t.status=n)}),n.service("GET","accounts").then(function(n){r.push(t.accounts=n)}),e.all(r).then(function(){a.resolve()}),a.promise}function o(n){for(var a=e.defer(),r=0,i=1,o=n.length-1;o>=0;o--){var c=n[o];i=t.categories[c.categoryId]&&"Expense"===t.categories[c.categoryId].parentId?-1:1,c.balance=r+i*c.amount,r=c.balance}return a.resolve(n),a.promise}t.categories=[],t.status=[],t.accounts=[],t.headers=["Date","Description","Account","Category","Amount","Balance","Status"],i().then(function(){("undefined"==typeof t.type||"credit"===t.type||"draft"===t.type)&&n.service("GET","transactions?_sort=date&_order=DESC").then(function(t){o(t).then(function(t){r(t)})})}),t.transformDate=function(t){return new Date(t)},t.$on("transactions:updated",function(e,a){1===n.getUpdateStatus()&&"search"!==t.type&&n.service("GET","transactions?_sort=date&_order=DESC").then(function(t){o(t).then(function(t){r(t),n.setUpdateStatus(2)})})}),t.$on("transactions:filter",function(e,r){1===n.getFilterStatus()&&"undefined"!=typeof t.filter&&n.service("GET","transactions?_sort=date&_order=DESC").then(function(e){o(e).then(function(e){t.transactions=a("filterSearchTransaction")(e,t.filter),n.setFilterStatus(2)})})})},link:function(t,n,e,a){}}});