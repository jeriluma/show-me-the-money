var app=angular.module("app",["ngMaterial"]);app.service("transactionsService",["$http","$q",function(t,n){this.service=function(e,a,i){var r=n.defer();return t({method:e,url:"http://localhost:3000/"+a,data:i}).then(function(t){r.resolve(t.data)},function(t){r.reject(t.statusText)}),r.promise}}]),app.directive("transactionsAdd",function(){return{restrict:"E",replace:!0,scope:!0,templateUrl:"app/components/transactions/add/view.html",controller:function(t,n,e){function a(){var a=e.defer(),i=[];return n.service("GET","categories").then(function(n){i.push(t.categories=n)}),n.service("GET","status").then(function(n){i.push(t.status=n)}),n.service("GET","accounts").then(function(n){i.push(t.accounts=n)}),e.all(i).then(function(){a.resolve()}),a.promise}var i=new Date;t.transaction={date:i,description:"",accountId:0,categoryId:0,statusId:0,parentId:0,amount:null},a(),this.isValid=function(){return""!==t.transaction.description&&0!==t.transaction.amount},this.updateData=function(){t.$emit("UPDATE_DATA_POST_COMPLETE",!1),n.service("POST","transactions/",t.transaction).then(function(){t.$emit("UPDATE_DATA_POST_COMPLETE",!0)})}},link:function(t,n,e,a){var i=($(n).find(".transaction-form"),$(n).find(".transaction-sync")),r=$(n).find(".transaction-submit");i.hide(),t.add=function(t){t.preventDefault(),a.isValid()&&r.fadeOut().promise().done(function(){i.fadeIn().promise().done(function(){a.updateData()})})},t.$on("UPDATE_DATA_GET_COMPLETE",function(){i.fadeOut(),r.fadeIn()})}}}),app.directive("transactionsDelete",function(){return{restrict:"A",scope:!0,controller:function(t,n,e,a){this.deleteData=function(i,r){var o=a.defer(),c=r.description,s=e.confirm().title("Would you like to delete this transaction?").textContent(c).ariaLabel(r.description).targetEvent(i).ok("Yes").cancel("No");return e.show(s).then(function(){t.$emit("UPDATE_DATA_POST_COMPLETE",!1),n.service("DELETE","transactions/"+r.id).then(function(){t.$emit("UPDATE_DATA_POST_COMPLETE",!0),o.resolve()})},function(){}),o.promise}},link:function(t,n,e,a){var i=$(n).find(".transaction-delete-trigger"),r=!1;i.hide(),$(n).bind("mouseover",function(){r||i.fadeIn()}),$(n).bind("mouseleave",function(){r||i.fadeOut()}),t["delete"]=function(t,n){r=!0,i.fadeIn().promise().then(function(){a.deleteData(t,n).then(function(){r=!1})})}}}}),app.directive("transactionsSummary",function(){return{restrict:"E",replace:!0,templateUrl:"app/components/transactions/summary/view.html",controller:function(t,n,e,a){t.balance={overall:"",debit:"",credit:""},this.init=function(){var i=a.defer();return n.service("GET","transactions?accountId=0&statusId=1&statusId=2").then(function(a){var r={overall:0,debit:0,credit:0};angular.forEach(a,function(t){r.debit+=t.amount}),n.service("GET","transactions?accountId=1&statusId=1&statusId=3").then(function(n){angular.forEach(n,function(t){r.credit+=t.amount}),r.overall=r.debit-r.credit,r.overall=e("currency")(r.overall,"$"),r.debit=e("currency")(r.debit,"$"),r.credit=e("currency")(r.credit,"$"),t.balance=r,i.resolve()})}),i.promise}},link:function(t,n,e,a){var i=$(n).find("p");i.hide(),a.init().then(function(){i.fadeIn()})}}}),app.directive("transactionsTable",function(){return{restrict:"E",replace:!0,scope:{type:"@",filter:"="},templateUrl:"app/components/transactions/table/view.html",controller:function(t,n,e){function a(){var a=e.defer(),i=[];return n.service("GET","categories").then(function(n){t.categories=n,i.push()}),n.service("GET","status").then(function(n){i.push(t.status=n)}),n.service("GET","accounts").then(function(n){i.push(t.accounts=n)}),e.all(i).then(function(){a.resolve()}),a.promise}function i(n){for(var a=e.defer(),i=0,r=1,o=n.length-1;o>=0;o--){var c=n[o];r=t.categories[c.categoryId]&&"Expense"===t.categories[c.categoryId].parentId?-1:1,c.balance=i+r*c.amount,i=c.balance}return a.resolve(n),a.promise}t.categories=[],t.status=[],t.accounts=[],t.headers=["Date","Description","Account","Category","Amount","Balance","Status"],a().then(function(){"search"!==t.type&&n.service("GET","transactions?_sort=date&_order=DESC").then(function(n){i(n).then(function(n){t.transactions=n})})}),t.transformDate=function(t){return new Date(t)},t.$on("UPDATE_DATA_POST_COMPLETE",function(e,a){a&&(t.$emit("UPDATE_DATA_GET_COMPLETE",!1),n.service("GET","transactions?_sort=date&_order=DESC").then(function(n){i(n).then(function(n){t.transactions=n,t.$emit("UPDATE_DATA_GET_COMPLETE",!0)})}))})},link:function(t,n,e,a){var i=$(n).find(".transaction-delete"),r=$(n).find(".transaction-sync");r.hide(),t["delete"]=function(){a.hasCheckedIds()&&i.fadeOut().promise().done(function(){r.fadeIn().promise().done(function(){a["delete"]().then(function(){r.fadeOut().promise().done(function(){i.fadeIn()})})})})}}}}),app.directive("transactionsTransactions",function(){return{restrict:"E",replace:!0,templateUrl:"app/components/transactions/transactions/view.html",controller:function(t,n,e){},link:function(t,n,e,a){}}}),app.directive("transactionsEdit",function(){return{restrict:"A",scope:!0,controller:function(t,n){this.isValid=function(t){return t==t},this.updateData=function(e){t.$emit("UPDATE_DATA_POST_COMPLETE",!1),n.service("PUT","transactions/"+e.id,e).then(function(){t.$emit("UPDATE_DATA_POST_COMPLETE",!0)})}},link:function(t,n,e,a){var i=$(n).find(".transaction-data"),r=$(n).find(".transaction-edit-trigger"),o=$(n).find(".transaction-edit"),c=$(n).find(".transaction-sync"),s=!1,u=!1;r.hide(),o.hide(),c.hide(),$(n).bind("mouseover",function(){$(n).removeClass("pointer"),u||($(n).addClass("pointer"),r.fadeIn().promise().done(function(){s=!0}))}),$(n).bind("mouseleave",function(){$(n).removeClass("pointer"),u||($(n).addClass("pointer"),r.fadeOut().promise().done(function(){s=!1}))}),$(n).bind("click",function(){s&&(u=!0,s=!1,r.hide().promise().done(function(){i.fadeOut().promise().done(function(){o.fadeIn()})}))}),t.save=function(t,n){n&&n.preventDefault(),a.isValid(t)&&o.fadeOut().promise().done(function(){c.fadeIn().promise().done(function(){a.updateData(t)})})},t.$on("UPDATE_DATA_GET_COMPLETE",function(){c.fadeOut().promise().done(function(){i.fadeIn(500).promise().done(function(){u=!1,r.show()})})})}}}),app.directive("transactionsSearch",function(){return{restrict:"E",replace:!0,templateUrl:"app/components/transactions/search/view.html",controller:function(t,n,e,a){function i(){var e=a.defer(),i=[];return n.service("GET","categories").then(function(n){i.push(t.categories=n)}),n.service("GET","status").then(function(n){i.push(t.status=n)}),n.service("GET","accounts").then(function(n){i.push(t.accounts=n)}),a.all(i).then(function(){e.resolve()}),e.promise}t.categories=[],t.status=[],t.accounts=[],t.headers=["Date","Description","Account","Category","Amount","Balance","Status"],t.transactions=[];var r=new Date;t.filterProperties={date:{start:null,end:r},description:"",accountId:"",categoryId:"",statusId:""},i(),this.getData=function(){var i=a.defer();return n.service("GET","transactions?_sort=date&_order=DESC").then(function(n){t.transactions=e("filterSearchTransaction")(n,t.filterProperties),t.filterProperties={date:{start:null,end:r},description:"",accountId:"",categoryId:"",statusId:""},i.resolve()}),i.promise},this.startData=function(){var n=a.defer();return n.resolve(t.transactions=[]),n.promise}},link:function(t,n,e,a){var i=$(n).find(".transaction-sync"),r=$(n).find(".transaction-search-element");i.hide(),t.search=function(t){t&&t.preventDefault(),a.startData().then(function(){r.fadeOut().promise().done(function(){i.fadeIn().promise().done(function(){a.getData().then(function(){i.fadeOut().promise().done(function(){r.fadeIn()})})})})})}}}}),app.filter("filterSearchTransaction",["$filter","$q",function(t){return function(n,e){var a=[];return angular.forEach(n,function(t){t.date=new Date(t.date);var n=null===e.date.start||t.date>=e.date.start,i=t.date<=e.date.end,r=""===e.accountId||t.accountId===e.accountId,o=""===e.categoryId||t.categoryId===e.categoryId,c=""===e.statusId||t.statusId===e.statusId;n&&i&&r&&o&&c&&a.push(t)}),""!==e.description&&(a=t("filter")(a,e.description)),a}}]);