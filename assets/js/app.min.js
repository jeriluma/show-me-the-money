var app=angular.module("app",["ngMaterial"]);app.service("transactionsService",["$http","$q",function(n,t){this.service=function(e,a,i){var r=t.defer();return setTimeout(function(){n({method:e,url:"http://localhost:3000/"+a,data:i}).then(function(n){r.resolve(n.data)},function(n){r.reject(n.statusText)})},50),r.promise}}]),app.directive("transactionsAdd",function(){return{restrict:"E",replace:!0,scope:!0,templateUrl:"app/components/transactions/add/view.html",require:"^transactionsTable",link:function(n,t,e,a){function i(){var t=!0;return""===n.transaction.description&&(t=!1),0===n.transaction.amount&&(t=!1),t}var r=($(t).find(".transaction-form"),$(t).find(".transaction-sync")),o=$(t).find(".transaction-submit");r.hide();var c=new Date;n.transaction={date:c,description:"",accountId:0,categoryId:0,statusId:0,parentId:0},n.add=function(t){t.preventDefault(),i()&&o.fadeOut().promise().done(function(){r.fadeIn().promise().done(function(){a.add(n.transaction).then(function(){r.fadeOut().promise().done(function(){o.fadeIn()})})})})}}}}),app.directive("transactionsEdit",function(){return{restrict:"A",require:"^transactionsTable",scope:!0,link:function(n,t,e,a){var i=$(t).find(".transaction-data"),r=$(t).find(".transaction-edit-trigger"),o=$(t).find(".transaction-edit"),c=$(t).find(".transaction-sync"),s=!1,d=!1;r.hide(),o.hide(),c.hide(),$(t).bind("mouseover",function(){$(t).removeClass("pointer"),d||($(t).addClass("pointer"),r.fadeIn().promise().done(function(){s=!0}))}),$(t).bind("mouseleave",function(){$(t).removeClass("pointer"),d||($(t).addClass("pointer"),r.fadeOut().promise().done(function(){s=!1}))}),$(t).bind("click",function(){s&&(d=!0,s=!1,r.hide().promise().done(function(){i.fadeOut().promise().done(function(){o.fadeIn()})}))}),n.save=function(n,t){t&&t.preventDefault(),o.fadeOut().promise().done(function(){c.fadeIn().promise().done(function(){a.edit(n).then(function(){c.fadeOut().promise().done(function(){i.fadeIn(500).promise().done(function(){d=!1,r.show()})})})})})}}}}),app.directive("transactionsSearch",function(){return{restrict:"E",replace:!0,templateUrl:"app/components/transactions/search/view.html",require:"^transactionsTable",link:function(n,t,e,a){var i=$(t).find(".transaction-sync"),r=$(t).find(".transaction-search-element");i.hide();var o=new Date;n.transaction={date:{start:null,end:o},description:"",accountId:"",categoryId:"",statusId:""},n.search=function(t){t&&t.preventDefault(),r.fadeOut().promise().done(function(){a.hideTable().then(function(){i.fadeIn().promise().done(function(){a.search(n.transaction).then(function(){i.fadeOut().promise().done(function(){r.fadeIn(),a.showTable()})})})})})}}}}),app.filter("filterSearchTransaction",["$filter","$q",function(n,t){return function(t,e){var a=[];return angular.forEach(t,function(n){n.date=new Date(n.date);var t=null===e.date.start||n.date>=e.date.start,i=n.date<=e.date.end,r=""===e.accountId||n.accountId===e.accountId,o=""===e.categoryId||n.categoryId===e.categoryId,c=""===e.statusId||n.statusId===e.statusId;t&&i&&r&&o&&c&&a.push(n)}),""!==e.description&&(a=n("filter")(a,e.description)),a}}]),app.directive("transactionsTable",function(){return{restrict:"E",replace:!0,templateUrl:"app/components/transactions/table/view.html",controller:function(n,t,e,a,i){function r(){var a=e.defer(),i=[];return i.push(n.loading=!0),t.service("GET","categories").then(function(t){i.push(n.categories=t)}),t.service("GET","status").then(function(t){i.push(n.status=t)}),t.service("GET","accounts").then(function(t){i.push(n.accounts=t)}),e.all(i).then(function(){a.resolve()}),a.promise}function o(t){for(var a=e.defer(),i=0,r=1,o=t.length-1;o>=0;o--){var c=t[o];r=n.categories[c.categoryId]&&"Expense"===n.categories[c.categoryId].parentId?-1:1,c.balance=i+r*c.amount,i=c.balance}return a.resolve(t),a.promise}function c(a,i,r){var c=e.defer();return t.service(a,i,r).then(function(){t.service("GET","transactions?_sort=date&_order=DESC").then(function(t){o(t).then(function(t){n.transactions=t,c.resolve()})})}),c.promise}n.categories=[],n.status=[],n.accounts=[],n.headers=[],r().then(function(){t.service("GET","transactions?_sort=date&_order=DESC").then(function(t){o(t).then(function(t){n.headers=["Date","Description","Account","Category","Amount","Balance","Status"],n.transactions=t,n.loading=!1})})}),n.transformDate=function(n){return new Date(n)},n.formatDate=function(n){return n.getMonth()+1+"/"+n.getDate()+"/"+n.getFullYear()},this.add=function(n){return c("POST","transactions/",n)};var s=!1;this.edit=function(n){var t=e.defer();return s=!0,c("PUT","transactions/"+n.id,n).then(function(){s=!1,t.resolve()}),t.promise},this.isEditing=function(){return s===!0};var d=[];n.checked=function(n){-1!==d.indexOf(n.id)?d.splice(d.indexOf(n.id),1):d.push(n.id)},this.hasCheckedIds=function(){return d.length>0},this["delete"]=function(){var n=e.defer(),t=[];return angular.forEach(d,function(n){t.push(c("DELETE","transactions/"+n))}),e.all(t).then(function(){d=[],n.resolve()}),n.promise};var u=[];this.search=function(n){var i=e.defer();return t.service("GET","transactions?_sort=date&_order=DESC").then(function(t){o(t).then(function(t){i.resolve(u=a("filterSearchTransaction")(t,n))})}),i.promise},this.hideTable=function(){var t=e.defer();return n.transactions=[],n.$apply(),t.resolve(),t.promise},this.showTable=function(){n.transactions=u,n.$apply()}},link:function(n,t,e,a){var i=$(t).find(".transaction-delete"),r=$(t).find(".transaction-sync");r.hide(),n["delete"]=function(){a.hasCheckedIds()&&i.fadeOut().promise().done(function(){r.fadeIn().promise().done(function(){a["delete"]().then(function(){r.fadeOut().promise().done(function(){i.fadeIn()})})})})}}}});